@using System
@using System.Linq
@using System.Threading.Tasks
@using System.Collections.Generic
@inject EvelynStores.Web.Services.ToastService ToastService
@implements IDisposable

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1050">
    @foreach (var t in toasts)
    {
        <div class="@($"toast show align-items-center text-bg-{GetBootstrapClass(t.Level)} mb-2")" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">@t.Message</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => Hide(t.Id)"></button>
            </div>
        </div>
    }
</div>

@code {
    private List<EvelynStores.Web.Services.ToastMessage> toasts = new();

    protected override void OnInitialized()
    {
        ToastService.OnShow += Show;
        ToastService.OnHide += Hide;
    }

    private void Show(EvelynStores.Web.Services.ToastMessage msg)
    {
        toasts.Add(msg);
        StateHasChanged();
        _ = Task.Run(async () =>
        {
            await Task.Delay(msg.Duration);
            Hide(msg.Id);
        });
    }

    private void Hide(Guid id)
    {
        var t = toasts.FirstOrDefault(x => x.Id == id);
        if (t != null)
        {
            toasts.Remove(t);
            InvokeAsync(StateHasChanged);
        }
    }

    private string GetBootstrapClass(EvelynStores.Web.Services.ToastLevel level) => level switch
    {
        EvelynStores.Web.Services.ToastLevel.Success => "success",
        EvelynStores.Web.Services.ToastLevel.Error => "danger",
        EvelynStores.Web.Services.ToastLevel.Warning => "warning",
        _ => "info",
    };

    public void Dispose()
    {
        ToastService.OnShow -= Show;
        ToastService.OnHide -= Hide;
    }
}
