@page "/admin/add-purchases"
@using EvelynStores.Core.DTOs
@using System.Text.Json
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@inject IEvelynPhilApiHttpClient ApiClient
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject EvelynStores.Web.Services.ToastService ToastService

<PageTitle>Add Product</PageTitle>

<div class="content">
    <div class="page-header">
        <div class="add-item d-flex">
            <div class="page-title">
                <h4 class="fw-bold">Create Purchase</h4>
                <h6>Create new Purchase</h6>
            </div>
        </div>
        <ul class="table-top-head"> 
            <li>
                <a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
            </li>
        </ul>
        <div class="page-btn mt-0">
            <a class="btn btn-secondary" href="/admin/purchase-list"><i data-feather="arrow-left" class="me-2"></i>Back to Purchase List</a>
        </div>
    </div>

    <EditForm Model="ProductModel" OnValidSubmit="HandleAdd" class="add-product-form">
        <DataAnnotationsValidator />
        <div class="add-product">
            <div class="accordions-items-separate" id="accordionSpacingExample">
                <div class="accordion-item border mb-4">
                    <h2 class="accordion-header" id="headingSpacingOne">
                        <div class="accordion-button collapsed bg-white" data-bs-toggle="collapse" data-bs-target="#SpacingOne" aria-expanded="true" aria-controls="SpacingOne">
                            <div class="d-flex align-items-center justify-content-between flex-fill">
                                <h5 class="d-flex align-items-center"><i data-feather="info" class="text-primary me-2"></i><span>Product Information</span></h5>
                            </div>
                        </div>
                    </h2>
                    <div id="SpacingOne" class="accordion-collapse collapse show" aria-labelledby="headingSpacingOne">
                        <div class="accordion-body border-top">

                            <div class="addservice-info">
                                <div class="row">
                                    <div class="col-sm-6 col-12">
                                        <div class="mb-3">
                                            <div class="add-newplus">
                                                <label class="form-label">Category<span class="text-danger ms-1">*</span></label>
                                                <a href="/admin/category-list" data-bs-toggle="modal" data-bs-target="#add-product-category">
                                                    <i data-feather="plus-circle" class="plus-down-add"></i><span>
                                                        Add
                                                        New
                                                    </span>
                                                </a>
                                            </div>
                                            <select class="form-control" @onchange="OnCategoryChanged">
                                                <option value="">Select</option>
                                                @foreach (var c in Categories)
                                                {
                                                    <option value="@c.Id">@c.Name</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-12">
                                        <div class="mb-3">
                                            <label class="form-label">Sub Category<span class="text-danger ms-1">*</span></label>
                                            <select class="form-control" @onchange="OnSubCategoryChanged">
                                                <option value="">Select</option>
                                                @foreach (var s in SubCategories)
                                                {
                                                    <option value="@s.Id">@s.Name</option>
                                                }
                                            </select>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-6 col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Product Name<span class="text-danger ms-1">*</span></label>
                                        <select class="form-select" @bind="ProductModel.ProductId" disabled="@IsLoadingProducts">
                                            <option value="">Select Product</option>
                                            @foreach (var p in FilteredProducts)
                                            {
                                                <option value="@p.Id">@p.Name</option>
                                            }
                                        </select>
                                        @if (IsLoadingProducts)
                                        {
                                            <span class="ms-2 align-middle"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></span>
                                        }
                                    </div>
                                </div>
                                
                                <div class="col-sm-6 col-12">
                                    <div class="mb-3 list position-relative">
                                        <label class="form-label">SKU/Batch No.<span class="text-danger ms-1">*</span></label>
                                        <InputText class="form-control list" @bind-Value="ProductModel.SKU" />
                                        <ValidationMessage For="() => ProductModel.SKU" />
                                        <button type="button" class="btn btn-primaryadd mt-2" @onclick="GenerateSku">Generate</button>
                                    </div>
                                </div> 
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item border mb-4">
                    <h2 class="accordion-header" id="headingSpacingTwo">
                        <div class="accordion-button collapsed bg-white" data-bs-toggle="collapse" data-bs-target="#SpacingTwo" aria-expanded="true" aria-controls="#SpacingTwo">
                            <div class="d-flex align-items-center justify-content-between flex-fill">
                                <h5 class="d-flex align-items-center"><i data-feather="life-buoy" class="text-primary me-2"></i><span>Pricing & Stocks</span></h5>
                            </div>
                        </div>
                    </h2>
                    <div id="SpacingTwo" class="accordion-collapse collapse show" aria-labelledby="headingSpacingTwo">
                        <div class="accordion-body border-top">
                            <div class="mb-3s">
                                
                                <div class="single-pill-product mb-3">
                                    <ul class="nav nav-pills" id="pills-tab1" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <span class="custom_radio me-4 mb-0 active" id="pills-home-tab" data-bs-toggle="pill"
                                                  data-bs-target="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">
                                                <input type="radio" class="form-control" name="payment">
                                                <span class="checkmark"></span> 
                                            </span>
                                        </li>
                                        
                                    </ul>
                                </div>
                            </div>
                            <div class="tab-content" id="pills-tabContent">
                                <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                                     aria-labelledby="pills-home-tab">
                                    <div class="single-product">
                                        <div class="row">
                                            <div class="col-sm-4 col-12">
                                                <div class="mb-3">
                                                    <label class="form-label">Quantity<span class="text-danger ms-1">*</span></label>
                                            <InputNumber class="form-control" @bind-Value="Quantity" />
                                                    <ValidationMessage For="() => ProductModel.Quantity" />
                                                </div>
                                            </div>
                                            <div class="col-sm-4 col-12">
                                                <div class="mb-3">
                                                    <label class="form-label">Unit Cost<span class="text-danger ms-1">*</span></label>
                                                    <InputNumber class="form-control" @bind-Value="UnitCostValue" />
                                                    <ValidationMessage For="() => ProductModel.UnitCost" />
                                                </div>
                                            </div>
                                            <div class="col-sm-4 col-12">
                                                <div class="mb-3">
                                                    <label class="form-label">Total Amount<span class="text-danger ms-1">*</span></label>
                                                    <InputNumber class="form-control" @bind-Value="ProductModel.TotalAmount" disabled />
                                                    <ValidationMessage For="() => ProductModel.TotalAmount" />
                                                </div>
                                            </div>
                                            
                                           
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item border mb-4">
                    <h2 class="accordion-header" id="headingSpacingFour">
                        <div class="accordion-button collapsed bg-white" data-bs-toggle="collapse" data-bs-target="#SpacingFour" aria-expanded="true" aria-controls="SpacingFour">
                            <div class="d-flex align-items-center justify-content-between flex-fill">
                                <h5 class="d-flex align-items-center"><i data-feather="list" class="text-primary me-2"></i><span>Custom Fields</span></h5>
                            </div>
                        </div>
                    </h2>
                    <div id="SpacingFour" class="accordion-collapse collapse show" aria-labelledby="headingSpacingFour">
                        <div class="accordion-body border-top">
                            <div> 
                                <div class="row">
                                    <div class="col-sm-6 col-12">
                                        <div class="mb-3">
                                            <label class="form-label">Manufactured Date<span class="text-danger ms-1">*</span></label>

                                            <div class="input-groupicon calender-input">
                                                <i data-feather="calendar" class="info-img"></i>
                                                <InputDate class="form-control" @bind-Value="ProductModel.ManufacturedDate" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-12">
                                        <div class="mb-3">
                                            <label class="form-label">Expiry On<span class="text-danger ms-1">*</span></label>

                                            <div class="input-groupicon calender-input">
                                                <i data-feather="calendar" class="info-img"></i>
                                                <InputDate class="form-control" @bind-Value="ProductModel.ExpiryDate" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="d-flex align-items-center justify-content-end mb-4">
                <button type="button" class="btn btn-secondary me-2" @onclick="Cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </div>
        </div>
    </EditForm>
</div>
<AddCategoryModal />
<DeleteModal />
@code {
    private PurchaseDto ProductModel { get; set; } = new PurchaseDto();
    private List<CategoryDto> Categories { get; set; } = new();
    private List<SubCategoryDto> SubCategories { get; set; } = new();
    private List<ProductDto> Products { get; set; } = new();
    private List<ProductDto> AllProducts { get; set; } = new();
    private List<ProductDto> FilteredProducts { get; set; } = new();
    private string Category { get; set; } = string.Empty;
    private string SubCategory { get; set; } = string.Empty;
    private string PrimaryImage { get; set; } = string.Empty; // stored URL returned from server
    private string PrimaryPreviewUrl { get; set; } = string.Empty; // data url for preview

    private bool IsLoading { get; set; }
    private bool isSubmitting { get; set; }
    private bool IsLoadingProducts { get; set; }

    private const long MaxFileBytes = 5 * 1024 * 1024; // 5 MB

    protected override async Task OnInitializedAsync()
    {
        await LoadFiltersAsync();
    }


    private async Task HandleAdd()
    {
        if (isSubmitting) return;
        isSubmitting = true;
        try
        {
            // ProductModel is bound to form inputs and validated by EditForm
            if (ProductModel.ProductId == Guid.Empty || string.IsNullOrWhiteSpace(ProductModel.SKU))
            {
                ToastService.ShowError("Please provide Name and SKU");
                return;
            }

            var res = await ApiClient.PostAsync<ProductDto>("/api/purchases", ProductModel);
            if (res.Success)
            {
                await ShowToastAsync("Product created successfully", "success");
                ResetForm();
                Navigation.NavigateTo("/admin/purchase-list");
            }
            else
            {
                await ShowToastAsync(res.Message ?? "Failed to create product", "error");
            }
        }
        catch (Exception ex)
        {
            await ShowToastAsync("Error: " + ex.Message, "error");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GenerateSku()
    {
        var rnd = new Random();
        ProductModel.SKU = $"BATCH-{DateTime.UtcNow:yyyyMMddHHmmss}-{rnd.Next(1000, 9999)}";
    }

    // Use Blazor ToastService instead of JS toastr
    private Task ShowToastAsync(string message, string type = "info")
    {
        switch (type)
        {
            case "success":
                ToastService.ShowSuccess(message);
                break;
            case "error":
                ToastService.ShowError(message);
                break;
            case "warning":
                ToastService.ShowWarning(message);
                break;
            default:
                ToastService.ShowInfo(message);
                break;
        }

        return Task.CompletedTask;
    }

    private async Task OnFileSelected(ChangeEventArgs e)
    {
        // Recommend using InputFile; notify user
        ToastService.ShowInfo("Please use the provided image upload widget (Drag & Drop) or use the Choose Image button.");
        await Task.CompletedTask;
    }

    private async Task UploadAndPreview(IBrowserFile file)
    {
        if (file == null) return;
        if (file.Size > MaxFileBytes)
        {
            ToastService.ShowError("File too large. Max 5 MB.");
            return;
        }

        var allowed = new[] { "image/jpeg", "image/png", "image/webp" };
        if (!allowed.Contains(file.ContentType))
        {
            ToastService.ShowError("Invalid file type. Only JPG, PNG, WEBP allowed.");
            return;
        }

        try
        {
            using var ms = new MemoryStream();
            await file.OpenReadStream(MaxFileBytes).CopyToAsync(ms);
            var bytes = ms.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            PrimaryPreviewUrl = $"data:{file.ContentType};base64,{base64}";

            PrimaryImage = PrimaryPreviewUrl;

            ToastService.ShowSuccess("Image loaded and will be saved with product.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Upload error: " + ex.Message);
        }
    }

    // Helper for file input via InputFile component if used in future
    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        var file = e.File;
        await UploadAndPreview(file);
    }

    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        Category = e?.Value?.ToString() ?? string.Empty;
        if (Guid.TryParse(Category, out var id))
        {
            ProductModel.CategoryId = id;
            SubCategories = new List<SubCategoryDto>();
            // fetch subcategories for selected category
            // Some endpoints return paged data in `data` as { items: [...], total, page, pageSize }
            // Try to read as PagedResult<SubCategoryDto> first and fall back to List<SubCategoryDto>
            var pagedRes = await ApiClient.GetAsync<PagedResult<SubCategoryDto>>($"/api/subcategories?categoryId={id}");
            if (pagedRes.Success && pagedRes.Data != null && pagedRes.Data.Items != null)
            {
                SubCategories = pagedRes.Data.Items;
            }
            else
            {
                // Fallback: try raw list
                var listRes = await ApiClient.GetAsync<List<SubCategoryDto>>($"/api/subcategories?categoryId={id}");
                if (listRes.Success && listRes.Data != null)
                {
                    SubCategories = listRes.Data;
                }
                else
                {
                    SubCategories = new List<SubCategoryDto>();
                }
            }

            FilteredProducts = new List<ProductDto>();
            StateHasChanged();
        }
        else
        {
            ProductModel.CategoryId = Guid.Empty;
            SubCategories = new List<SubCategoryDto>();
        }
    }

    private Task OnSubCategoryChanged(ChangeEventArgs e)
    {
        SubCategory = e?.Value?.ToString() ?? string.Empty;
        if (Guid.TryParse(SubCategory, out var id))
        {
            ProductModel.SubCategoryId = id;
            // server-side filter: request products for subcategory
            _ = LoadProductsBySubCategoryAsync(id);
        }
        else
        {
            ProductModel.SubCategoryId = Guid.Empty;
            // fetch all products from server
            _ = LoadAllProductsAsync();
        }
        return Task.CompletedTask;
    }

    private async Task LoadProductsBySubCategoryAsync(Guid subCategoryId)
    {
        IsLoadingProducts = true;
        StateHasChanged();
        try
        {
            var res = await ApiClient.GetAsync<List<ProductDto>>($"/api/products?subCategoryId={subCategoryId}");
            if (res.Success && res.Data != null)
            {
                FilteredProducts = res.Data.OrderByDescending(p => p.CreatedAt).ToList();
            }
            else
            {
                FilteredProducts = new List<ProductDto>();
            }
            StateHasChanged();
        }
        catch
        {
            Products = new List<ProductDto>();
        }
        finally
        {
            IsLoadingProducts = false;
            StateHasChanged();
        }
    }

    private async Task LoadAllProductsAsync()
    {
        IsLoadingProducts = true;
        StateHasChanged();
        try
        {
            var res = await ApiClient.GetAsync<List<ProductDto>>("/api/products");
            if (res.Success && res.Data != null)
            {
                Products = res.Data.OrderByDescending(p => p.CreatedAt).ToList();
            }
            else
            {
                Products = new List<ProductDto>();
            }
        }
        catch
        {
            Products = new List<ProductDto>();
        }
        finally
        {
            IsLoadingProducts = false;
            StateHasChanged();
        }
    }

    private void ClearPrimaryImage()
    {
        PrimaryImage = string.Empty;
        PrimaryPreviewUrl = string.Empty;
    }

    private void ResetForm()
    {
        ProductModel = new PurchaseDto();
        Category = string.Empty;
        SubCategory = string.Empty;
        PrimaryImage = string.Empty;
        PrimaryPreviewUrl = string.Empty;
    }

    private async Task RefreshForm()
    {
         IsLoading = true;
         try
         {
             ResetForm();
             await LoadFiltersAsync();
         }
         finally { IsLoading = false; }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin/product-list");
    }

    private async Task LoadFiltersAsync()
    {
         IsLoading = true;
         try
         {
             var cres = await ApiClient.GetAsync<List<CategoryDto>>("/api/categories");
             if (cres.Success && cres.Data != null) Categories = cres.Data;
             else Categories = new List<CategoryDto>();

            var prods = await ApiClient.GetAsync<List<ProductDto>>("/api/products");
            if (prods.Success && prods.Data != null)
            {
                AllProducts = prods.Data.OrderByDescending(p => p.CreatedAt).ToList();
                Products = AllProducts.ToList();
            }
            else
            {
                AllProducts = new List<ProductDto>();
                Products = new List<ProductDto>();
            }

             SubCategories = new List<SubCategoryDto>();
         }
         catch
         {
             Categories = new List<CategoryDto>();
             SubCategories = new List<SubCategoryDto>();
         }
         finally { IsLoading = false; }
     }

    private void RecalculateTotal(ChangeEventArgs e)
    {
        try
        {
            ProductModel.TotalAmount = (decimal)(ProductModel.UnitCost * ProductModel.Quantity);
        }
        catch
        {
            ProductModel.TotalAmount = 0;
        }
    }

    // use backing properties to trigger recalculation in their setters so UI updates as values change
    private int Quantity
    {
        get => ProductModel.Quantity;
        set
        {
            ProductModel.Quantity = value;
            ProductModel.TotalAmount = (decimal)(ProductModel.UnitCost * ProductModel.Quantity);
        }
    }

    private double UnitCostValue
    {
        get => ProductModel.UnitCost;
        set
        {
            ProductModel.UnitCost = value;
            ProductModel.TotalAmount = (decimal)(ProductModel.UnitCost * ProductModel.Quantity);
        }
    }
 }
