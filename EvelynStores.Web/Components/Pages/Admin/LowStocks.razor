@page "/admin/low-stocks"
@using EvelynStores.Core.DTOs
@inject IEvelynPhilApiHttpClient ApiClient
@inject NavigationManager Navigation
@inject EvelynStores.Web.Services.ToastService ToastService
@inject IJSRuntime JS

<PageTitle>Low Stocks</PageTitle>
<div class="content">
	<div class="page-header">
		<div class="page-title me-auto">
			<h4 class="fw-bold">Low Stocks</h4>
			<h6>Manage your low stocks</h6>
		</div>
		<ul class="table-top-head low-stock-top-head"> 
			<li>
				<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i class="ti ti-refresh"></i></a>
			</li>
			<li>
				<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
			</li> 
		</ul>
	</div>
	<div class="mb-4">
		<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
			<ul class="nav nav-pills low-stock-tab d-flex me-2 mb-0" id="pills-tab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Low Stocks</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Out of Stocks</button>
				</li>

			</ul>
			 
		</div>
		<div class="tab-content" id="pills-tabContent">
			<div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
				<!-- /product list -->
                <div class="card">
					<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
						<div class="search-set">
							<div class="search-input">
								<span class="btn-searchset"><i class="ti ti-search fs-14 feather-search"></i></span>
                                <input class="form-control ms-2" placeholder="Search by name or SKU" @bind="LowSearchTerm" @bind:event="oninput" />
                            </div>
						</div>

						<div class="d-flex table-dropdown my-xl-auto right-content align-items-center flex-wrap row-gap-3">
							  
                            <div style="min-width:200px;">
                                <select class="form-select" @onchange="OnLowCategoryChanged">
                                    <option value="">All Categories</option>
                                    @foreach (var c in Categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </select>
                            </div>
						</div>
					</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table datatable">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>SKU</th>
                                        <th>Qty</th>
                                        <th>Qty Alert</th>
                                        <th class="no-sort"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (LowStockList == null)
                                    {
                                        <tr><td colspan="6" class="text-center p-4">Loading...</td></tr>
                                    }
                                    else if (!LowStockList.Any())
                                    {
                                        <tr><td colspan="6" class="text-center p-4">No low stock items.</td></tr>
                                    }
                                    else
                                    {
                                        @foreach (var p in LowStockList)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <a href="javascript:void(0);" class="avatar avatar-md me-2">
                                                            <img src="@(string.IsNullOrEmpty(p.ImageUrl) ? "assets/img/products/stock-img-01.png" : p.ImageUrl)" alt="product">
                                                        </a>
                                                        <a href="#" @onclick="() => ViewProduct(p.Id)" @onclick:preventDefault="true">@p.Name</a>
                                                    </div>
                                                </td>
                                                <td>@(Categories.FirstOrDefault(c => c.Id == p.CategoryId)?.Name ?? "-")</td>
                                                <td>@p.SKU</td>
                                                <td>@p.Quantity</td>
                                                <td>@p.ReOrderLevel</td>
                                                <td class="action-table-data">
                                                    <div class="edit-delete-action">
														<a class="me-2 p-2" href="#" @onclick="() => ShowEditStock(p)" @onclick:preventDefault="true"><i data-feather="edit" class="bi bi-folder2-open"></i></a>
                                                        <a class="p-2" href="#" @onclick="() => ConfirmDelete(p.Id)" @onclick:preventDefault="true"><i data-feather="trash-2" class="bi bi-trash3"></i></a>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
				</div>
				<!-- /product list -->
			</div>
			<div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
				<!-- /product list -->
				<div class="card">
					<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
						<div class="search-set">
							<div class="search-input">
						<span class="btn-searchset"><i class="ti ti-search fs-14 feather-search"></i></span>
                        <input class="form-control ms-2" placeholder="Search by name or SKU" @bind="OutSearchTerm" @bind:event="oninput" />
							</div>
						</div>
						<div class="d-flex table-dropdown my-xl-auto right-content align-items-center flex-wrap row-gap-3">
							 
                            <div class="me-2" style="min-width:200px;">
                                <select class="form-select" @onchange="OnOutCategoryChanged">
                                    <option value="">All Categories</option>
                                    @foreach (var c in Categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </select>
                            </div>
						</div>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table datatable">
								<thead class="thead-light">
									<tr>
										 
										<th>Product Name</th>
										<th>Category</th>
										<th>SKU</th>
										<th>Qty</th>
										<th>Qty Alert</th>
										<th class="no-sort">Action</th>
									</tr>
								</thead>
					<tbody>
						@if (OutOfStockList == null)
						{
							<tr><td colspan="6" class="text-center p-4">Loading...</td></tr>
						}
						else if (!OutOfStockList.Any())
						{
							<tr><td colspan="6" class="text-center p-4">No out of stock items.</td></tr>
						}
						else
						{
							@foreach (var p in OutOfStockList)
							{
								<tr>
									<td>
										<div class="d-flex align-items-center">
											<a href="javascript:void(0);" class="avatar avatar-md me-2">
												<img src="@(string.IsNullOrEmpty(p.ImageUrl) ? "assets/img/products/stock-img-01.png" : p.ImageUrl)" alt="product">
											</a>
											<a href="#" @onclick="() => ViewProduct(p.Id)" @onclick:preventDefault="true">@p.Name</a>
										</div>
									</td>
									<td>@(Categories.FirstOrDefault(c => c.Id == p.CategoryId)?.Name ?? "-")</td>
									<td>@p.SKU</td>
									<td>@p.Quantity</td>
									<td>@p.ReOrderLevel</td>
									<td class="action-table-data">
										<div class="edit-delete-action">
											<a class="me-2 p-2" href="#" @onclick="() => ShowEditStock(p)" @onclick:preventDefault="true"><i data-feather="edit" class="bi bi-folder2-open"></i></a>
											<a class="p-2" href="#" @onclick="() => ConfirmDelete(p.Id)" @onclick:preventDefault="true"><i data-feather="trash-2" class="bi bi-trash3"></i></a>
										</div>
									</td>
								</tr>
							}
						}
						</tbody>
							</table>
						</div>
					</div>
				</div>
				<!-- /product list -->
			</div>

		</div>
	</div>
</div>

<!-- Edit Low Stock -->
<div class="modal fade" id="edit-stock">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<div class="page-title">
					<h4>Edit Low Stocks</h4>
				</div>
				<button type="button" class="close bg-danger text-white fs-16" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true" class="fs-16">&times;</span>
				</button>
			</div>
            @* Edit form shown only when an item is selected for edit to avoid EditForm null model error *@
            @if (EditProductModel != null)
            {
                <EditForm Model="EditProductModel" OnValidSubmit="SaveStockChanges">
                    <DataAnnotationsValidator />
                <div class="modal-body pb-0">
                    <div class="row">
                        <div class="col-sm-6 mb-3">
                            <label class="form-label">SKU<span class="text-danger ms-1">*</span></label>
                            <InputText disabled class="form-control" @bind-Value="EditProductModel.SKU" />
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label">Category<span class="text-danger ms-1">*</span></label>
                            <select class="form-select" @bind="EditProductModel.CategoryId">
                                <option value="">Select</option>
                                @foreach (var c in Categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Product Name<span class="text-danger ms-1">*</span></label>
								<InputText class="form-control" @bind-Value="EditProductModel.Name" />
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label">Qty<span class="text-danger ms-1">*</span></label>
                            <InputNumber class="form-control" @bind-Value="EditProductModel.Quantity" />
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label">Qty Alert<span class="text-danger ms-1">*</span></label>
								<InputNumber class="form-control" @bind-Value="EditProductModel.ReOrderLevel" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-2 btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
                </EditForm>
            }
		</div>
	</div>
</div>
<!-- / Edit Low Stock -->
<!-- delete modal -->
<div class="modal fade" id="delete-modal">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="page-wrapper-new p-0">
				<div class="content p-5 px-3 text-center">
					<span class="rounded-circle d-inline-flex p-2 bg-danger-transparent mb-2"><i class="ti ti-trash fs-24 text-danger"></i></span>
					<h4 class="fs-20 fw-bold mb-2 mt-1">Delete Product</h4>
					<p class="mb-0 fs-16">Are you sure you want to delete product from low stock?</p>
					<div class="modal-footer-btn mt-3 d-flex justify-content-center">
						<button type="button" class="btn me-2 btn-secondary fs-13 fw-medium p-2 px-3 shadow-none" data-bs-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary fs-13 fw-medium p-2 px-3">Yes Delete</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
@code {
    private List<ProductDto>? AllProducts { get; set; }
    private List<ProductDto>? LowStockList { get; set; }
    private List<ProductDto>? OutOfStockList { get; set; }
    private List<CategoryDto> Categories { get; set; } = new();

    private ProductDto? EditProductModel { get; set; }
    private Guid? SelectedDeleteId;

    private string _lowSearchTerm = string.Empty;
    private string LowSearchTerm
    {
        get => _lowSearchTerm;
        set
        {
            _lowSearchTerm = value;
            ApplyFilters();
        }
    }

    private string _outSearchTerm = string.Empty;
    private string OutSearchTerm
    {
        get => _outSearchTerm;
        set
        {
            _outSearchTerm = value;
            ApplyFilters();
        }
    }

    private Guid? LowSelectedCategoryId = null;
    private Guid? OutSelectedCategoryId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookupsAsync();
        await LoadProductsAsync();
    }

    private async Task LoadLookupsAsync()
    {
        try
        {
            var cres = await ApiClient.GetAsync<List<CategoryDto>>("/api/categories");
            if (cres.Success && cres.Data != null) Categories = cres.Data;
        }
        catch { }
    }

    private async Task LoadProductsAsync()
    {
        LowStockList = null;
        OutOfStockList = null;
        try
        {
            var res = await ApiClient.GetAsync<List<ProductDto>>("/api/products");
            if (res.Success && res.Data != null)
            {
                AllProducts = res.Data.OrderByDescending(p => p.CreatedAt).ToList();
                ApplyFilters();
            }
            else
            {
                AllProducts = new List<ProductDto>();
                LowStockList = new List<ProductDto>();
                OutOfStockList = new List<ProductDto>();
                ToastService.ShowError(res.Message ?? "Failed to load products");
            }
        }
        catch (Exception ex)
        {
            AllProducts = new List<ProductDto>();
            LowStockList = new List<ProductDto>();
            OutOfStockList = new List<ProductDto>();
            ToastService.ShowError("Error: " + ex.Message);
        }
    }

    private void ApplyFilters()
    {
        if (AllProducts == null)
        {
            LowStockList = new List<ProductDto>();
            OutOfStockList = new List<ProductDto>();
            return;
        }

        IEnumerable<ProductDto> q = AllProducts;

        // apply search for the two tabs independently
        if (!string.IsNullOrWhiteSpace(LowSearchTerm) || !string.IsNullOrWhiteSpace(OutSearchTerm))
        {
            // if filtering low-stock tab (LowSearchTerm set) apply it
            var lowS = LowSearchTerm?.Trim();
            var outS = OutSearchTerm?.Trim();
            if (!string.IsNullOrWhiteSpace(lowS) && string.IsNullOrWhiteSpace(outS))
            {
                q = q.Where(p => p.Name.Contains(lowS, StringComparison.OrdinalIgnoreCase) || p.SKU.Contains(lowS, StringComparison.OrdinalIgnoreCase));
            }
            else if (!string.IsNullOrWhiteSpace(outS) && string.IsNullOrWhiteSpace(lowS))
            {
                q = q.Where(p => p.Name.Contains(outS, StringComparison.OrdinalIgnoreCase) || p.SKU.Contains(outS, StringComparison.OrdinalIgnoreCase));
            }
            else if (!string.IsNullOrWhiteSpace(lowS) && !string.IsNullOrWhiteSpace(outS))
            {
                // if both set, apply both (intersection)
                q = q.Where(p => (p.Name.Contains(lowS, StringComparison.OrdinalIgnoreCase) || p.SKU.Contains(lowS, StringComparison.OrdinalIgnoreCase))
                                 || (p.Name.Contains(outS, StringComparison.OrdinalIgnoreCase) || p.SKU.Contains(outS, StringComparison.OrdinalIgnoreCase)));
            }
        }

        // apply category filters per-tab if set
        if (LowSelectedCategoryId.HasValue && LowSelectedCategoryId != Guid.Empty)
        {
            q = q.Where(p => p.CategoryId == LowSelectedCategoryId.Value);
        }
        if (OutSelectedCategoryId.HasValue && OutSelectedCategoryId != Guid.Empty)
        {
            q = q.Where(p => p.CategoryId == OutSelectedCategoryId.Value);
        }

        // Low stock: quantity <= reorder level but > 0
        LowStockList = q.Where(p => p.Quantity > 0 && p.Quantity <= p.ReOrderLevel).OrderBy(p => p.Quantity).ToList();

        // Out of stock: quantity == 0
        OutOfStockList = q.Where(p => p.Quantity == 0).OrderBy(p => p.Name).ToList();
    }

    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        var val = e?.Value?.ToString();
        if (Guid.TryParse(val, out var gid))
        {
            LowSelectedCategoryId = gid;
            OutSelectedCategoryId = gid;
        }
        else
        {
            LowSelectedCategoryId = null;
            OutSelectedCategoryId = null;
        }
        ApplyFilters();
        await Task.CompletedTask;
    }

    private async Task OnLowCategoryChanged(ChangeEventArgs e)
    {
        var val = e?.Value?.ToString();
        if (Guid.TryParse(val, out var gid)) LowSelectedCategoryId = gid; else LowSelectedCategoryId = null;
        ApplyFilters();
        await Task.CompletedTask;
    }

    private async Task OnOutCategoryChanged(ChangeEventArgs e)
    {
        var val = e?.Value?.ToString();
        if (Guid.TryParse(val, out var gid)) OutSelectedCategoryId = gid; else OutSelectedCategoryId = null;
        ApplyFilters();
        await Task.CompletedTask;
    }

    private void ShowEditStock(ProductDto p)
    {
        EditProductModel = new ProductDto
        {
            Id = p.Id,
            Name = p.Name,
            SKU = p.SKU,
            CategoryId = p.CategoryId,
            Quantity = p.Quantity,
            ReOrderLevel = p.ReOrderLevel
        };
        try { _ = JS.InvokeVoidAsync("eval", "$('#edit-stock').modal('show');"); } catch { }
// This is a placeholder for a new comment or code addition.
    }

    private async Task SaveStockChanges()
    {
        if (EditProductModel == null) return;
        try
        {
			var res = await ApiClient.PutAsync<ProductDto>($"/api/products/{EditProductModel.Id}", EditProductModel);
            if (res.Success)
            {
                ToastService.ShowSuccess("Stock updated");
                await LoadProductsAsync();
                try { _ = JS.InvokeVoidAsync("eval", "$('#edit-stock').modal('hide');"); } catch { }
            }
            else
            {
                ToastService.ShowError(res.Message ?? "Failed to update stock");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error: " + ex.Message);
        }
    }

    private void ConfirmDelete(Guid id)
    {
        SelectedDeleteId = id;
        try { _ = JS.InvokeVoidAsync("eval", "$('#delete-modal').modal('show');"); } catch { }
    }

    private void ViewProduct(Guid id) => Navigation.NavigateTo($"/admin/product-details/{id}");

    private async Task DeleteProduct(Guid id)
    {
        try
        {
            var res = await ApiClient.DeleteAsync($"/api/products/{id}");
            if (res.Success)
            {
                ToastService.ShowSuccess("Product deleted");
                await LoadProductsAsync();
            }
            else
            {
                ToastService.ShowError(res.Message ?? "Failed to delete product");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error: " + ex.Message);
        }
    }

    private async Task Refresh()
    {
        await LoadProductsAsync();
    }
}
