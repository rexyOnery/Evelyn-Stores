@page "/admin/product-details/{ProductId:guid}"
@using EvelynStores.Core.DTOs
@inject IEvelynPhilApiHttpClient ApiClient
@inject NavigationManager Navigation
@inject EvelynStores.Web.Services.ToastService ToastService
@inject IJSRuntime JS

<PageTitle>Product Details</PageTitle>
<div class="content">
    <div class="page-header d-flex align-items-center justify-content-between">
        <div class="page-title">
            <h4>Product Details</h4>
            <h6>Full details of a product</h6>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary" @onclick="Back">Back</button>
            <button class="btn btn-primary" @onclick="() => EditProduct(Product?.Id ?? Guid.Empty)" disabled="@(!CanEdit)">Edit</button>
            <button class="btn btn-danger" @onclick="() => ConfirmDelete(Product?.Id ?? Guid.Empty)" disabled="@(!CanDelete)">Delete</button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-sm-12">
            <div class="card">
                <div class="card-body">
                    <div class="bar-code-view d-flex justify-content-between align-items-start mb-3">
                        <div class="product-details-barcode">
                            @if (!string.IsNullOrEmpty(Product?.SKU))
                            {
                                <div class="mb-2"><strong>SKU:</strong> @Product.SKU</div>
                                <img src="assets/img/barcode/barcode1.png" class="barcode" alt="barcode">
                            }
                        </div>
                        <div>
                            <button class="btn btn-light" @onclick="Print"> <i class="ti ti-printer"></i> Print</button>
                        </div>
                    </div>

                    @if (IsLoading)
                    {
                        <div>Loading...</div>
                    }
                    else if (LoadError != null)
                    {
                        <div class="alert alert-danger">@LoadError</div>
                    }
                    else if (Product != null)
                    {
                        <div class="productdetails">
                            <ul class="product-bar list-unstyled">
                                <li><h6 class="mb-1">Product</h6><div>@Product.Name</div></li>
                                <li><h6 class="mb-1">Category</h6><div>@GetCategoryName(Product.CategoryId)</div></li>
                                <li><h6 class="mb-1">Sub Category</h6><div>@GetSubCategoryName(Product.SubCategoryId)</div></li>
                                @* <li><h6 class="mb-1">Brand</h6><div>@GetBrandName(Product.BrandId)</div></li> *@
                                <li><h6 class="mb-1">Unit</h6><div>@Product.Unit</div></li>
                                <li><h6 class="mb-1">SKU</h6><div>@Product.SKU</div></li>
                                <li><h6 class="mb-1">ReOrder Qty</h6><div>@Product.ReOrderLevel</div></li>
                                <li><h6 class="mb-1">Quantity</h6><div>@Product.Quantity</div></li>
                                <li><h6 class="mb-1">Price</h6><div>@Product.Price.ToString("C")</div></li>
                                <li><h6 class="mb-1">Manufactured Date</h6><div>@(Product.ManufacturedDate?.ToString("dd MMM yyyy") ?? "-")</div></li>
                                <li><h6 class="mb-1">Expiry Date</h6><div>@(Product.ExpiryDate?.ToString("dd MMM yyyy") ?? "-")</div></li>
                                <li><h6 class="mb-1">Description</h6><div>@(Product.Name)</div></li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-sm-12">
            <div class="card">
                <div class="card-body text-center">
                    @if (Product == null)
                    {
                        <img src="assets/img/products/stock-img-01.png" alt="product" class="img-fluid" />
                    }
                    else
                    {
                        <img src="@(string.IsNullOrEmpty(Product.ImageUrl) ? "assets/img/products/stock-img-01.png" : Product.ImageUrl)" alt="product" class="img-fluid mb-2" />
                        <div class="fw-bold">@Product.Name</div>
                        <div class="text-muted">@Product.SKU</div>
                        <div class="mt-3">Price: ₦@Product.Price.ToString("C").Substring(1)</div>
                        <div class="mt-1">Qty: @Product.Quantity</div>
                    }
                </div>
            </div>
        </div>
    </div>

</div>

<DeleteModal Entity="Product" EntityId="SelectedDeleteId" OnConfirm="DeleteProduct" />

@code {
    [Parameter]
    public Guid ProductId { get; set; }

    private ProductDto? Product;
    private bool IsLoading { get; set; }
    private string? LoadError { get; set; }
    private Guid? SelectedDeleteId;

    private List<CategoryDto> Categories { get; set; } = new();
    private List<SubCategoryDto> SubCategories { get; set; } = new();
    private List<BrandDto> Brands { get; set; } = new();

    private bool CanEdit => Product != null;
    private bool CanDelete => Product != null;

    protected override async Task OnParametersSetAsync()
    {
        await LoadLookupsAsync();
        await LoadProductAsync();
    }

    private async Task LoadProductAsync()
    {
        IsLoading = true;
        LoadError = null;
        Product = null;
        try
        {
            var res = await ApiClient.GetAsync<ProductDto>($"/api/products/{ProductId}");
            if (res.Success && res.Data != null)
            {
                Product = res.Data;
            }
            else
            {
                LoadError = res.Message ?? "Failed to load product";
                ToastService.ShowError(LoadError);
            }
        }
        catch (Exception ex)
        {
            LoadError = ex.Message;
            ToastService.ShowError(LoadError);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadLookupsAsync()
    {
        try
        {
            var cres = await ApiClient.GetAsync<List<CategoryDto>>("/api/categories");
            if (cres.Success && cres.Data != null) Categories = cres.Data;

            var bres = await ApiClient.GetAsync<List<BrandDto>>("/api/brands");
            if (bres.Success && bres.Data != null) Brands = bres.Data;

            var sres = await ApiClient.GetAsync<List<SubCategoryDto>>("/api/subcategories/all");
            if (sres.Success && sres.Data != null) SubCategories = sres.Data;
        }
        catch { }
    }

    private string GetCategoryName(Guid id) => Categories.FirstOrDefault(c => c.Id == id)?.Name ?? "-";
    private string GetBrandName(Guid id) => Brands.FirstOrDefault(b => b.Id == id)?.Name ?? "-";
    private string GetSubCategoryName(Guid id) => SubCategories.FirstOrDefault(s => s.Id == id)?.Name ?? "-";

    private void Back() => Navigation.NavigateTo("/admin/product-list");
    private void EditProduct(Guid id)
    {
        if (id == Guid.Empty) return;
        Navigation.NavigateTo($"/admin/edit-product/{id}");
    }

    private void ConfirmDelete(Guid id)
    {
        if (id == Guid.Empty) return;
        SelectedDeleteId = id;
        _ = JSInvokeShowDelete();
    }

    private async Task JSInvokeShowDelete()
    {
        try { await JS.InvokeVoidAsync("eval", "$('#delete-modal').modal('show');"); } catch { }
    }

    private async Task DeleteProduct(Guid id)
    {
        try
        {
            var res = await ApiClient.DeleteAsync($"/api/products/{id}");
            if (res.Success)
            {
                ToastService.ShowSuccess("Product deleted");
                Navigation.NavigateTo("/admin/product-list");
            }
            else
            {
                ToastService.ShowError(res.Message ?? "Failed to delete product");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error: " + ex.Message);
        }
    }

    private async Task Print()
    {
        try
        {
            await JS.InvokeVoidAsync("print");
        }
        catch { }
    }
}
