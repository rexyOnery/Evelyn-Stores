@page "/admin/add-product"
@using EvelynStores.Core.DTOs
@using System.Text.Json
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@inject IEvelynPhilApiHttpClient ApiClient
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject EvelynStores.Web.Services.ToastService ToastService

<PageTitle>Add Product</PageTitle>

<div class="content">
    <div class="page-header">
        <div class="add-item d-flex">
            <div class="page-title">
                <h4 class="fw-bold">Create Product</h4>
                <h6>Create new product</h6>
            </div>
        </div>
        <ul class="table-top-head">
            <li>
                <button class="btn btn-link p-0" type="button" title="Refresh" @onclick="RefreshForm"><i class="ti ti-refresh"></i></button>
            </li>
            <li>
                <a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
            </li>
        </ul>
        <div class="page-btn mt-0">
            <a class="btn btn-secondary" href="/admin/product-list"><i data-feather="arrow-left" class="me-2"></i>Back to Product</a>
        </div>
    </div>

    <EditForm Model="ProductModel" OnValidSubmit="HandleAdd" class="add-product-form">
        <DataAnnotationsValidator />
        <div class="add-product">
            <div class="accordions-items-separate" id="accordionSpacingExample">
                <div class="accordion-item border mb-4">
                    <h2 class="accordion-header" id="headingSpacingOne">
                        <div class="accordion-button collapsed bg-white" data-bs-toggle="collapse" data-bs-target="#SpacingOne" aria-expanded="true" aria-controls="SpacingOne">
                            <div class="d-flex align-items-center justify-content-between flex-fill">
                                <h5 class="d-flex align-items-center"><i data-feather="info" class="text-primary me-2"></i><span>Product Information</span></h5>
                            </div>
                        </div>
                    </h2>
                    <div id="SpacingOne" class="accordion-collapse collapse show" aria-labelledby="headingSpacingOne">
                        <div class="accordion-body border-top">

                            <div class="addservice-info">
                                <div class="row">
                                    <div class="col-sm-6 col-12">
                                        <div class="mb-3">
                                            <div class="add-newplus">
                                                <label class="form-label">Category<span class="text-danger ms-1">*</span></label>
                                                <a href="/admin/category-list" data-bs-toggle="modal" data-bs-target="#add-product-category">
                                                    <i data-feather="plus-circle" class="plus-down-add"></i><span>
                                                        Add
                                                        New
                                                    </span>
                                                </a>
                                            </div>
                                            <select class="form-control" @onchange="OnCategoryChanged">
                                                <option value="">Select</option>
                                                @foreach (var c in Categories)
                                                {
                                                    <option value="@c.Id">@c.Name</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-12">
                                        <div class="mb-3">
                                            <label class="form-label">Sub Category<span class="text-danger ms-1">*</span></label>
                                            <select class="form-control" @onchange="OnSubCategoryChanged">
                                                <option value="">Select</option>
                                                @foreach (var s in SubCategories)
                                                {
                                                    <option value="@s.Id">@s.Name</option>
                                                }
                                            </select>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-6 col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Product Name<span class="text-danger ms-1">*</span></label>
                                        <InputText class="form-control" @bind-Value="ProductModel.Name" />
                                        <ValidationMessage For="() => ProductModel.Name" />
                                    </div>
                                </div>
                                
                              <div class="col-sm-6 col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Unit<span class="text-danger ms-1">*</span></label>
                                        <select class="form-control" @bind="ProductModel.Unit">
                                            <option>Select</option>
                                            <option>Kg</option>
                                            <option>Pcs</option>
                                            <option>L</option>
                                            <option>dz</option>
                                            <option>bx</option>
                                        </select>
                                    </div>
                                </div>  
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item border mb-4">
                    <h2 class="accordion-header" id="headingSpacingThree">
                        <div class="accordion-button collapsed bg-white" data-bs-toggle="collapse" data-bs-target="#SpacingThree" aria-expanded="true" aria-controls="SpacingThree">
                            <div class="d-flex align-items-center justify-content-between flex-fill">
                                <h5 class="d-flex align-items-center"><i data-feather="image" class="text-primary me-2"></i><span>Images</span></h5>
                            </div>
                        </div>
                    </h2>
                    <div id="SpacingThree" class="accordion-collapse collapse show" aria-labelledby="headingSpacingThree">
                        <div class="accordion-body border-top">
                            <div class="text-editor add-list add">
                                <div class="col-lg-12">
                                    <div class="add-choosen">
                                        <div class="mb-3">
                                            <div class="image-upload image-upload-two">
                                                <InputFile OnChange="OnInputFileChanged" />
                                                <div class="image-uploads">
                                                    <i data-feather="plus-circle" class="plus-down-add me-0"></i>
                                                    <h4>Add Images</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="phone-img">
                                            @if (!string.IsNullOrEmpty(PrimaryPreviewUrl))
                                            {
                                                <img src="@PrimaryPreviewUrl" alt="image">
                                            }
                                            else
                                            {
                                                <img src="assets/img/products/phone-add-2.png" alt="image">
                                            }
                                            <a href="javascript:void(0);"><i data-feather="x" class="x-square-add remove-product" @onclick="ClearPrimaryImage"></i></a>
                                        </div>  
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        <div class="col-lg-12">
            <div class="d-flex align-items-center justify-content-end mb-4">
                <button type="button" class="btn btn-secondary me-2" @onclick="Cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </div>
        </div>
    </EditForm>
</div>
<AddCategoryModal />
<DeleteModal />
@code {
    private ProductDto ProductModel { get; set; } = new ProductDto();
    private List<CategoryDto> Categories { get; set; } = new();
    private List<SubCategoryDto> SubCategories { get; set; } = new();
    private string Category { get; set; } = string.Empty;
    private string SubCategory { get; set; } = string.Empty;
    private string PrimaryImage { get; set; } = string.Empty; // stored URL returned from server
    private string PrimaryPreviewUrl { get; set; } = string.Empty; // data url for preview

    private bool IsLoading { get; set; }
    private bool isSubmitting { get; set; }

    private const long MaxFileBytes = 5 * 1024 * 1024; // 5 MB

    protected override async Task OnInitializedAsync()
    {
       await LoadFiltersAsync();
    }
    private async Task HandleAdd()
    {
        if (isSubmitting) return;
        isSubmitting = true;
        try
        {
            // ProductModel is bound to form inputs and validated by EditForm
            if (string.IsNullOrWhiteSpace(ProductModel.Name) )//|| string.IsNullOrWhiteSpace(ProductModel.SKU))
            {
                ToastService.ShowError("Please provide Name and SKU");
                return;
            }
            ProductModel.ImageUrl = PrimaryImage ?? string.Empty;

            var res = await ApiClient.PostAsync<ProductDto>("/api/products", ProductModel);
            if (res.Success)
            {
                await ShowToastAsync("Product created successfully", "success");
                ResetForm();
                Navigation.NavigateTo("/admin/product-list");
            }
            else
            {
                await ShowToastAsync(res.Message ?? "Failed to create product", "error");
            }
        }
        catch (Exception ex)
        {
            await ShowToastAsync("Error: " + ex.Message, "error");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    
    // Use Blazor ToastService instead of JS toastr
    private Task ShowToastAsync(string message, string type = "info")
    {
        switch (type)
        {
            case "success":
                ToastService.ShowSuccess(message);
                break;
            case "error":
                ToastService.ShowError(message);
                break;
            case "warning":
                ToastService.ShowWarning(message);
                break;
            default:
                ToastService.ShowInfo(message);
                break;
        }

        return Task.CompletedTask;
    }

    private async Task OnFileSelected(ChangeEventArgs e)
    {
         // Recommend using InputFile; notify user
         ToastService.ShowInfo("Please use the provided image upload widget (Drag & Drop) or use the Choose Image button.");
         await Task.CompletedTask;
    }

    private async Task UploadAndPreview(IBrowserFile file)
    {
        if (file == null) return;
        if (file.Size > MaxFileBytes)
        {
            ToastService.ShowError("File too large. Max 5 MB.");
            return;
        }

        var allowed = new[] { "image/jpeg", "image/png", "image/webp" };
        if (!allowed.Contains(file.ContentType))
        {
            ToastService.ShowError("Invalid file type. Only JPG, PNG, WEBP allowed.");
            return;
        }

        try
        {
            using var ms = new MemoryStream();
            await file.OpenReadStream(MaxFileBytes).CopyToAsync(ms);
            var bytes = ms.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            PrimaryPreviewUrl = $"data:{file.ContentType};base64,{base64}";

            PrimaryImage = PrimaryPreviewUrl;

            ToastService.ShowSuccess("Image loaded and will be saved with product.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Upload error: " + ex.Message);
        }
    }

    // Helper for file input via InputFile component if used in future
    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        var file = e.File;
        await UploadAndPreview(file);
    }

    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        Category = e?.Value?.ToString() ?? string.Empty;
        if (Guid.TryParse(Category, out var id))
        {
             ProductModel.CategoryId = id;
             // fetch subcategories for selected category
             // Some endpoints return paged data in `data` as { items: [...], total, page, pageSize }
             // Try to read as PagedResult<SubCategoryDto> first and fall back to List<SubCategoryDto>
             var pagedRes = await ApiClient.GetAsync<PagedResult<SubCategoryDto>>($"/api/subcategories?categoryId={id}");
             if (pagedRes.Success && pagedRes.Data != null && pagedRes.Data.Items != null)
             {
                 SubCategories = pagedRes.Data.Items;
             }
             else
             {
                 // Fallback: try raw list
                 var listRes = await ApiClient.GetAsync<List<SubCategoryDto>>($"/api/subcategories?categoryId={id}");
                 if (listRes.Success && listRes.Data != null)
                 {
                     SubCategories = listRes.Data;
                 }
                 else
                 {
                     SubCategories = new List<SubCategoryDto>();
                 }
             }
         }
         else
         {
             ProductModel.CategoryId = Guid.Empty;
             SubCategories = new List<SubCategoryDto>();
         }
    }

    private Task OnSubCategoryChanged(ChangeEventArgs e)
    {
        SubCategory = e?.Value?.ToString() ?? string.Empty;
        if (Guid.TryParse(SubCategory, out var id))
        {
             ProductModel.SubCategoryId = id;
        }
        else
        {
             ProductModel.SubCategoryId = Guid.Empty;
        }
        return Task.CompletedTask;
    }

    private void ClearPrimaryImage()
    {
        PrimaryImage = string.Empty;
        PrimaryPreviewUrl = string.Empty;
    }

    private void ResetForm()
    {
        ProductModel = new ProductDto();
        Category = string.Empty;
        SubCategory = string.Empty;
        PrimaryImage = string.Empty;
        PrimaryPreviewUrl = string.Empty;
    }

    private async Task RefreshForm()
    {
         IsLoading = true;
         try
         {
             ResetForm();
             await LoadFiltersAsync();
         }
         finally { IsLoading = false; }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin/product-list");
    }

    private async Task LoadFiltersAsync()
    {
         IsLoading = true;
         try
         {
             var cres = await ApiClient.GetAsync<List<CategoryDto>>("/api/categories");
             if (cres.Success && cres.Data != null) Categories = cres.Data;
             else Categories = new List<CategoryDto>();

             SubCategories = new List<SubCategoryDto>();
         }
         catch
         {
             Categories = new List<CategoryDto>();
             SubCategories = new List<SubCategoryDto>();
         }
         finally { IsLoading = false; }
     }
 }
