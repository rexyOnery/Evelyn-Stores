@page "/admin/brand-list"
@using EvelynStores.Core.DTOs
@using System.Text.Json
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@inject IEvelynPhilApiHttpClient ApiClient
@inject IJSRuntime JS

<PageTitle>Brand Management</PageTitle>

<div class="content">
	<div class="page-header d-flex align-items-center justify-content-between">
		<div class="page-title">
			<h4 class="fw-bold">Brand</h4>
			<h6>Manage your brands</h6>
		</div>
		<div class="d-flex gap-2">
			<button class="btn btn-primary" @onclick="ShowAddModal">Add Brand</button>
			<button class="btn btn-outline-secondary" @onclick="Reload" disabled="@IsLoading">
				@if (IsLoading) { <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> }
				<i class="ti ti-refresh"></i> Refresh
			</button>
		</div>
	</div>

	<div class="card mt-3">
		<div class="card-header d-flex align-items-center justify-content-between">
			<div class="search-set d-flex align-items-center">
				<input class="form-control me-2" placeholder="Search brands" @bind="searchTerm" @bind:event="oninput" />
				<button class="btn btn-outline-secondary" @onclick="OnSearch">Search</button>
			</div>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table">
					<thead class="thead-light">
						<tr>
							<th>Brand</th>
							<th>Created Date</th>
							<th>Status</th>
							<th class="text-end">Actions</th>
						</tr>
					</thead>
					<tbody>
						@if (IsLoading)
						{
							<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>
						}
						else if (Brands.Count == 0)
						{
							<tr><td colspan="4" class="text-center p-4">No brands found.</td></tr>
						}
						else
						{
							@foreach (var b in Brands)
							{
								<tr>
									<td class="align-middle">
										<div class="d-flex align-items-center">
											@if (!string.IsNullOrEmpty(b.ImageUrl))
											{
												<img src="@b.ImageUrl" alt="brand" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:8px" />
											}
											<span>@b.Name</span>
										</div>
									</td>
									<td class="align-middle">@b.CreatedAt.ToString("dd MMM yyyy")</td>
									<td class="align-middle">@(b.IsActive ? (MarkupString)"<span class=\"badge bg-success\">Active</span>" : (MarkupString)"<span class=\"badge bg-secondary\">Inactive</span>")</td>
									<td class="text-end align-middle">
										<button class="btn btn-sm btn-outline-secondary me-2" @onclick="() => ShowEditModal(b)">Edit</button>
										<button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(b.Id)">Delete</button>
									</td>
								</tr>
							}
						}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- Add Brand Modal -->
<div class="modal fade" id="add-brand" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add Brand</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<EditForm Model="AddModel" OnValidSubmit="HandleAdd">
				<DataAnnotationsValidator />
				<div class="modal-body">
					<ValidationSummary />
					<div class="mb-3">
						<label class="form-label">Brand Name</label>
						<InputText class="form-control" @bind-Value="AddModel.Name" />
					</div>
					<div class="mb-3">
						<label class="form-label">Image (JPEG/PNG/WEBP, max 5MB)</label>
						<InputFile OnChange="OnAddImageSelected" />
						@if (!string.IsNullOrEmpty(AddPreviewUrl))
						{
							<img src="@AddPreviewUrl" alt="preview" style="max-width:120px;max-height:80px;margin-top:8px;border-radius:6px" />
						}
					</div>
					<div class="mb-3">
						<label class="form-label">Active</label>
						<InputCheckbox class="form-check-input" @bind-Value="AddModel.IsActive" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add Brand</button>
				</div>
			</EditForm>
		</div>
	</div>
</div>

<!-- Edit Brand Modal -->
<div class="modal fade" id="edit-brand" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Edit Brand</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<EditForm Model="EditModel" OnValidSubmit="HandleEdit">
				<DataAnnotationsValidator />
				<div class="modal-body">
					<ValidationSummary />
					<div class="mb-3">
						<label class="form-label">Brand Name</label>
						<InputText class="form-control" @bind-Value="EditModel.Name" />
					</div>
					<div class="mb-3">
						<label class="form-label">Image (JPEG/PNG/WEBP, max 5MB)</label>
						<InputFile OnChange="OnEditImageSelected" />
						@if (!string.IsNullOrEmpty(EditPreviewUrl))
						{
							<img src="@EditPreviewUrl" alt="preview" style="max-width:120px;max-height:80px;margin-top:8px;border-radius:6px" />
						}
					</div>
					<div class="mb-3">
						<label class="form-label">Active</label>
						<InputCheckbox class="form-check-input" @bind-Value="EditModel.IsActive" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Save Changes</button>
				</div>
			</EditForm>
		</div>
	</div>
</div>

<DeleteModal EntityId="DeleteId" Entity="Brand" OnConfirm="OnDeleteConfirmed" />

@code {
	private List<BrandDto> Brands { get; set; } = new();
	private BrandDto AddModel { get; set; } = new BrandDto { IsActive = true };
	private BrandDto EditModel { get; set; } = new BrandDto();
	private Guid? DeleteId { get; set; }
	private bool IsLoading { get; set; }
	private string searchTerm = string.Empty;

	// image upload state
	private IBrowserFile? AddImageFile;
	private IBrowserFile? EditImageFile;
	private string? AddPreviewUrl;
	private string? EditPreviewUrl;
	private const long MaxFileBytes = 5 * 1024 * 1024; // 5 MB

	protected override async Task OnInitializedAsync()
	{
		await LoadAsync();
	}

	private async Task LoadAsync()
	{
		IsLoading = true;
		try
		{
			var q = string.IsNullOrWhiteSpace(searchTerm) ? string.Empty : $"?searchTerm={Uri.EscapeDataString(searchTerm)}";
			var res = await ApiClient.GetAsync<List<BrandDto>>($"/api/brands{q}");
			if (res.Success && res.Data != null)
			{
				Brands = res.Data.OrderByDescending(b => b.CreatedAt).ToList();
			}
			else
			{
				Brands = new List<BrandDto>();
			}
		}
		catch
		{
			Brands = new List<BrandDto>();
		}
		finally { IsLoading = false; }
	}

	private async Task OnSearch()
	{
		await LoadAsync();
	}

	private async Task Reload()
	{
		searchTerm = string.Empty;
		await LoadAsync();
	}

	private async Task ShowAddModal()
	{
		AddModel = new BrandDto { IsActive = true };
		AddImageFile = null;
		AddPreviewUrl = null;
		try { await JS.InvokeVoidAsync("eval", "$('#add-brand').modal('show');"); } catch { }
	}

	private async Task OnAddImageSelected(InputFileChangeEventArgs e)
	{
		AddImageFile = e.File;
		try
		{
			using var stream = AddImageFile.OpenReadStream(MaxFileBytes);
			var buffer = new byte[stream.Length > int.MaxValue ? int.MaxValue : (int)stream.Length];
			await stream.ReadAsync(buffer.AsMemory(0, buffer.Length));
			var base64 = Convert.ToBase64String(buffer);
			AddPreviewUrl = $"data:{AddImageFile.ContentType};base64,{base64}";
		}
		catch { AddPreviewUrl = null; }
	}

	private async Task OnEditImageSelected(InputFileChangeEventArgs e)
	{
		EditImageFile = e.File;
		try
		{
			using var stream = EditImageFile.OpenReadStream(MaxFileBytes);
			var buffer = new byte[stream.Length > int.MaxValue ? int.MaxValue : (int)stream.Length];
			await stream.ReadAsync(buffer.AsMemory(0, buffer.Length));
			var base64 = Convert.ToBase64String(buffer);
			EditPreviewUrl = $"data:{EditImageFile.ContentType};base64,{base64}";
		}
		catch { EditPreviewUrl = null; }
	}

	private async Task<ImageUploadResult?> UploadImageAsync(IBrowserFile file)
	{
		if (file == null) return null;
		if (file.Size > MaxFileBytes)
		{
			await JS.InvokeVoidAsync("alert", "File too large. Max 5 MB.");
			return null;
		}

		var allowed = new[] { "image/jpeg", "image/png", "image/webp" };
		if (!allowed.Contains(file.ContentType))
		{
			await JS.InvokeVoidAsync("alert", "Invalid file type. Only JPG, PNG, WEBP allowed.");
			return null;
		}

		try
		{
			using var stream = file.OpenReadStream(MaxFileBytes);
			using var content = new MultipartFormDataContent();
			var streamContent = new StreamContent(stream);
			streamContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
			content.Add(streamContent, "file", file.Name);

			var response = await ApiClient.PostMultipartAsync($"/api/brands/upload", content);
			var body = await response.Content.ReadAsStringAsync();
			var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
			var apiRes = JsonSerializer.Deserialize<EvelynPhilApiResponse<ImageUploadResult>>(body, options);
			if (apiRes != null && apiRes.Success && apiRes.Data != null)
			{
				return apiRes.Data;
			}
			else
			{
				await JS.InvokeVoidAsync("alert", apiRes?.Message ?? "Upload failed");
				return null;
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("alert", "Upload error: " + ex.Message);
			return null;
		}
	}

	private async Task HandleAdd()
	{
		try
		{
			if (AddImageFile != null)
			{
				var uploaded = await UploadImageAsync(AddImageFile);
				if (uploaded != null) AddModel.ImageUrl = uploaded.OriginalUrl;
			}

			var res = await ApiClient.PostAsync<BrandDto>("/api/brands", AddModel);
			if (res.Success)
			{
				try { await JS.InvokeVoidAsync("eval", "$('#add-brand').modal('hide');"); } catch { }
				await LoadAsync();
			}
			else
			{
				await JS.InvokeVoidAsync("alert", res.Message ?? "Failed to add brand");
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("alert", "Error: " + ex.Message);
		}
	}

	private async Task ShowEditModal(BrandDto item)
	{
		EditModel = new BrandDto
		{
			Id = item.Id,
			Name = item.Name,
			IsActive = item.IsActive,
			CreatedAt = item.CreatedAt,
			ImageUrl = item.ImageUrl
		};
		EditImageFile = null;
		EditPreviewUrl = EditModel.ImageUrl;
		try { await JS.InvokeVoidAsync("eval", "$('#edit-brand').modal('show');"); } catch { }
	}

	private async Task HandleEdit()
	{
		try
		{
			if (EditImageFile != null)
			{
				var uploaded = await UploadImageAsync(EditImageFile);
				if (uploaded != null) EditModel.ImageUrl = uploaded.OriginalUrl;
			}

			var res = await ApiClient.PutAsync<BrandDto>($"/api/brands/{EditModel.Id}", EditModel);
			if (res.Success)
			{
				try { await JS.InvokeVoidAsync("eval", "$('#edit-brand').modal('hide');"); } catch { }
				await LoadAsync();
			}
			else
			{
				await JS.InvokeVoidAsync("alert", res.Message ?? "Failed to update brand");
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("alert", "Error: " + ex.Message);
		}
	}

	private async Task ConfirmDelete(Guid id)
	{
		DeleteId = id;
		try { await JS.InvokeVoidAsync("eval", "$('#delete-modal').modal('show');"); } catch { }
	}

	private async Task OnDeleteConfirmed(Guid id)
	{
		try
		{
			var res = await ApiClient.DeleteAsync($"/api/brands/{id}");
			if (res.Success)
			{
				await LoadAsync();
			}
			else
			{
				await JS.InvokeVoidAsync("alert", res.Message ?? "Failed to delete brand");
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("alert", "Error: " + ex.Message);
		}
	}
}
