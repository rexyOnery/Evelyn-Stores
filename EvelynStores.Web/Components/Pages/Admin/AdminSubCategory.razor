@page "/admin/sub-categories"
@using EvelynStores.Core.DTOs
@inject IEvelynPhilApiHttpClient ApiClient
@inject IJSRuntime JS

<PageTitle>Sub-Category</PageTitle>

<div class="content">
	<div class="page-header d-flex align-items-center justify-content-between">
		<div class="page-title">
			<h4 class="fw-bold">Sub Category</h4>
			<h6>Manage your sub categories</h6>
		</div>
		<div>
			<button class="btn btn-primary" @onclick="ShowAddModal"><i class="ti ti-circle-plus me-1"></i>Add Sub Category</button>
		</div>
	</div>

	<div class="card mt-3">
		<div class="card-header">
			<div class="row g-2 align-items-center">
				<div class="col-sm-4">
					<div class="input-group">
						<input class="form-control" placeholder="Search by name or code" @bind="searchTerm" @bind:event="oninput" />
						<button class="btn btn-outline-secondary" @onclick="OnSearch">Search</button>
					</div>
				</div>
				<div class="col-sm-3">
					<select class="form-select" @onchange="OnStatusChanged">
						<option value="All" selected>All Status</option>
						<option value="Active">Active</option>
						<option value="Inactive">Inactive</option>
					</select>
				</div>
				<div class="col-sm-3">
					<select class="form-select" @onchange="OnCategoryChanged">
						<option value="">All Categories</option>
						@foreach (var c in Categories)
						{
							<option value="@c.Id">@c.Name</option>
						}
					</select>
				</div>
				<div class="col-sm-2 text-end">
					<button class="btn btn-outline-secondary" @onclick="Reload" disabled="@IsLoading">
						@if (IsLoading)
						{
							<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
						}
						Refresh
					</button>
				</div>
			</div>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table">
					<thead class="thead-light">
						<tr>
							<th>Sub Category</th>
							<th>Category</th>
							<th>Category Code</th>
							<th>Description</th>
							<th>Status</th>
							<th class="text-end">Actions</th>
						</tr>
					</thead>
					<tbody>
						@if (IsLoading)
						{
							<tr><td colspan="6" class="text-center p-4">Loading...</td></tr>
						}
						else if (Paged?.Items?.Count == 0)
						{
							<tr><td colspan="6" class="text-center p-4">No records found.</td></tr>
						}
						else
						{
							@foreach (var item in Paged.Items)
							{
								<tr>
									<td>@item.Name</td>
									<td>@(Categories.FirstOrDefault(c => c.Id == item.CategoryId)?.Name ?? "-")</td>
									<td>@item.Code</td>
									<td class="text-truncate" style="max-width:250px">@item.Description</td>
									<td>
										@if (item.IsActive)
										{
											<span class="badge bg-success">Active</span>
										}
										else
										{
											<span class="badge bg-secondary">Inactive</span>
										}
									</td>
									<td class="text-end">
										<button class="me-2 p-2 btn btn-link" @onclick="() => ShowEditModal(item)">
											<i data-feather="edit" class="bi bi-folder2-open"></i>
										</button>
										<button class="p-2 btn btn-link text-danger" @onclick="() => ConfirmDelete(item.Id)">
											<i data-feather="trash-2" class="bi bi-trash3"></i>
										</button>
									</td>
								</tr>
							}
						}
					</tbody>
				</table>
			</div>
		</div>
		<div class="card-footer d-flex justify-content-between align-items-center">
			<div>
				Showing @((Paged?.Items?.Count) ?? 0) of @((Paged?.TotalCount) ?? 0) entries
			</div>
			<div>
				<nav>
					<ul class="pagination mb-0">
						<li class="page-item @(Page==1?"disabled":"")"><a class="page-link" href="#" @onclick="PrevPage">Previous</a></li>
						@for (int i = 1; i <= TotalPages; i++)
						{
							<li class="page-item @(i==Page?"active":"")"><a class="page-link" href="#" @onclick="(()=>GoToPage(i))">@i</a></li>
						}
						<li class="page-item @(Page==TotalPages?"disabled":"")"><a class="page-link" href="#" @onclick="NextPage">Next</a></li>
					</ul>
				</nav>
			</div>
		</div>
	</div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="add-subcategory" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add Sub Category</h5>
				<button type="button" class="close bg-danger text-white fs-16" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<EditForm Model="AddModel" OnValidSubmit="HandleAdd">
				<DataAnnotationsValidator />
				<div class="modal-body">
					<ValidationSummary />
					<div class="mb-3">
						<label class="form-label">SubCategory Name</label>
						<InputText class="form-control" @bind-Value="AddModel.Name" />
					</div>
					<div class="mb-3">
						<label class="form-label">Category</label>
						<select class="form-select" @bind="AddModel.CategoryId">
							<option value="">Select Category</option>
							@foreach (var c in Categories)
							{
								<option value="@c.Id">@c.Name</option>
							}
						</select>
					</div>
					<div class="mb-3">
						<label class="form-label">Code</label>
						<InputText class="form-control" @bind-Value="AddModel.Code" />
					</div>
					<div class="mb-3">
						<label class="form-label">Description</label>
						<InputTextArea class="form-control" @bind-Value="AddModel.Description" />
					</div>
					<div class="form-check mb-2">
						 
						<InputCheckbox id="add-isactive" class="check" @bind-Value="AddModel.IsActive" />
						<label for="add-isactive" class="checktoggle"></label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn me-2 btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add</button>
				</div>
			</EditForm>
		</div>
	</div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="edit-subcategory" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Edit Sub Category</h5>
				<button type="button" class="close bg-danger text-white fs-16" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<EditForm Model="EditModel" OnValidSubmit="HandleEdit">
				<DataAnnotationsValidator />
				<div class="modal-body">
					<ValidationSummary />
					<div class="mb-3">
						<label class="form-label">SubCategory Name</label>
						<InputText class="form-control" @bind-Value="EditModel.Name" />
					</div>
					<div class="mb-3">
						<label class="form-label">Category</label>
						<select class="form-select" @bind="EditModel.CategoryId">
							<option value="">Select Category</option>
							@foreach (var c in Categories)
							{
								<option value="@c.Id">@c.Name</option>
							}
						</select>
					</div>
					<div class="mb-3">
						<label class="form-label">Code</label>
						<InputText class="form-control" @bind-Value="EditModel.Code" />
					</div>
					<div class="mb-3">
						<label class="form-label">Description</label>
						<InputTextArea class="form-control" @bind-Value="EditModel.Description" />
					</div>
					<div class="form-check mb-2">
						 
						<InputCheckbox id="edit-isactive" class="check" @bind-Value="EditModel.IsActive" />
						<label for="edit-isactive" class="checktoggle"></label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn me-2 btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Save Changes</button>
				</div>
			</EditForm>
		</div>
	</div>
</div>

<DeleteModal EntityId="DeleteId" Entity="Sub Category" OnConfirm="OnDeleteConfirmed" />

@code {
	private PagedResponse<SubCategoryDto>? Paged { get; set; } = new();
	private List<CategoryDto> Categories { get; set; } = new();
	private SubCategoryDto AddModel { get; set; } = new SubCategoryDto();
	private SubCategoryDto EditModel { get; set; } = new SubCategoryDto();
	private Guid? DeleteId { get; set; }

	private int Page { get; set; } = 1;
	private int PageSize { get; set; } = 10;
	private string searchTerm = string.Empty;
	private string status = "All";
	private Guid? filterCategoryId = null;
	private bool IsLoading { get; set; }

	protected override async Task OnInitializedAsync()
	{
		await LoadCategoriesAsync();
		await LoadAsync();
	}

	private async Task LoadCategoriesAsync()
	{
		var res = await ApiClient.GetAsync<List<CategoryDto>>("/api/categories");
		if (res.Success && res.Data != null)
		{
			Categories = res.Data;
		}
	}

	private async Task LoadAsync()
	{
		IsLoading = true;
		try
		{
			var endpoint = $"/api/subcategories?searchTerm={Uri.EscapeDataString(searchTerm ?? string.Empty)}&status={status}&page={Page}&pageSize={PageSize}";
			if (filterCategoryId.HasValue && filterCategoryId != Guid.Empty) endpoint += $"&categoryId={filterCategoryId.Value}";

			var res = await ApiClient.GetAsync<PagedResponse<SubCategoryDto>>(endpoint);
			if (res.Success && res.Data != null)
			{
				Paged = res.Data;
			}
			else
			{
				Paged = new PagedResponse<SubCategoryDto>();
			}
		}
		catch
		{
			Paged = new PagedResponse<SubCategoryDto>();
		}
		finally
		{
			IsLoading = false;
		}
	}

	private int TotalPages => (int)Math.Ceiling(((double)(Paged?.TotalCount ?? 0) / PageSize));

	private async Task OnSearch()
	{
		Page = 1;
		await LoadAsync();
	}

	private async Task OnStatusChanged(ChangeEventArgs e)
	{
		status = e?.Value?.ToString() ?? "All";
		Page = 1;
		await LoadAsync();
	}

	private async Task OnCategoryChanged(ChangeEventArgs e)
	{
		var val = e?.Value?.ToString();
		if (Guid.TryParse(val, out var g)) filterCategoryId = g; else filterCategoryId = null;
		Page = 1;
		await LoadAsync();
	}

	private async Task Reload()
	{
		// Reset filters and reload categories and list
		IsLoading = true;
		try
		{
			searchTerm = string.Empty;
			status = "All";
			filterCategoryId = null;
			Page = 1;

			await LoadCategoriesAsync();
			await LoadAsync();
		}
		catch
		{
			// ignore
		}
		finally
		{
			IsLoading = false;
		}
	}

	private async Task ShowAddModal()
	{
		AddModel = new SubCategoryDto { IsActive = true };
		try { await JS.InvokeVoidAsync("eval", "$('#add-subcategory').modal('show');"); } catch { }
	}

	private async Task HandleAdd()
	{
		try
		{
			var res = await ApiClient.PostAsync<SubCategoryDto>("/api/subcategories", AddModel);
			if (res.Success)
			{
				try { await JS.InvokeVoidAsync("eval", "$('#add-subcategory').modal('hide');"); } catch { }
				await LoadAsync();
			}
			else
			{
				// show error
				await ShowAlert(res.Message ?? "Failed to add sub category");
			}
		}
		catch (Exception ex)
		{
			await ShowAlert("Error: " + ex.Message);
		}
	}

	private async Task ShowEditModal(SubCategoryDto item)
	{
		EditModel = new SubCategoryDto
		{
			Id = item.Id,
			Name = item.Name,
			CategoryId = item.CategoryId,
			Code = item.Code,
			Description = item.Description,
			IsActive = item.IsActive,
			Slug = item.Slug,
			CreatedAt = item.CreatedAt
		};
		try { await JS.InvokeVoidAsync("eval", "$('#edit-subcategory').modal('show');"); } catch { }
	}

	private async Task HandleEdit()
	{
		try
		{
			var res = await ApiClient.PutAsync<SubCategoryDto>($"/api/subcategories/{EditModel.Id}", EditModel);
			if (res.Success)
			{
				try { await JS.InvokeVoidAsync("eval", "$('#edit-subcategory').modal('hide');"); } catch { }
				await LoadAsync();
			}
			else
			{
				await ShowAlert(res.Message ?? "Failed to update sub category");
			}
		}
		catch (Exception ex)
		{
			await ShowAlert("Error: " + ex.Message);
		}
	}

	private async Task ConfirmDelete(Guid id)
	{
		DeleteId = id;
		try { await JS.InvokeVoidAsync("eval", "$('#delete-modal').modal('show');"); } catch { }
	}

	private async Task OnDeleteConfirmed(Guid id)
	{
		try
		{
			var res = await ApiClient.DeleteAsync($"/api/subcategories/{id}");
			if (res.Success)
			{
				await LoadAsync();
			}
			else
			{
				await ShowAlert(res.Message ?? "Failed to delete");
			}
		}
		catch (Exception ex)
		{
			await ShowAlert("Error: " + ex.Message);
		}
	}

	private async Task PrevPage()
	{
		if (Page > 1) {
			Page--;
			await LoadAsync();
		}
	}

	private async Task NextPage()
	{
		if (Page < TotalPages) {
			Page++;
			await LoadAsync();
		}
	}

	private async Task GoToPage(int i)
	{
		Page = i;
		await LoadAsync();
	}

	private async Task ShowAlert(string message)
	{
		// simple JS alert — in production you may use a toast service
		await JS.InvokeVoidAsync("alert", message);
	}
}
